name: PR Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    permissions:
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Render
        id: deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BRANCH_NAME: ${{ github.head_ref }}
        run: |
          # Create a unique service name for this PR
          SERVICE_NAME="imageoptimizer-pr-${PR_NUMBER}"
          
          # Check if service already exists
          SERVICE_ID=$(curl -s -H "Authorization: Bearer ${RENDER_API_KEY}" \
            "https://api.render.com/v1/services" | \
            jq -r ".[] | select(.service.name == \"${SERVICE_NAME}\") | .service.id" || echo "")
          
          if [ -z "$SERVICE_ID" ]; then
            # Create new service
            echo "Creating new preview service: ${SERVICE_NAME}"
            RESPONSE=$(curl -s -X POST "https://api.render.com/v1/services" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{
                "type": "web_service",
                "name": "'"${SERVICE_NAME}"'",
                "repo": "'"${{ github.repository }}"'",
                "branch": "'"${BRANCH_NAME}"'",
                "autoDeploy": "yes",
                "envVars": [
                  {"key": "PYTHON_VERSION", "value": "3.12.0"},
                  {"key": "SECRET_KEY", "generateValue": true},
                  {"key": "DEBUG", "value": "False"},
                  {"key": "ALLOWED_HOSTS", "value": "*"},
                  {"key": "DATABASE_URL", "value": "sqlite:///db.sqlite3"},
                  {"key": "STORAGE_ENCRYPTION_KEY", "generateValue": true}
                ],
                "buildCommand": "pip install -r requirements.txt && python manage.py migrate && python manage.py collectstatic --noinput",
                "startCommand": "gunicorn imageoptimizer.wsgi:application --bind 0.0.0.0:$PORT"
              }')
            SERVICE_ID=$(echo $RESPONSE | jq -r '.service.id')
            PREVIEW_URL=$(echo $RESPONSE | jq -r '.service.serviceDetails.url')
          else
            # Trigger redeployment
            echo "Redeploying existing service: ${SERVICE_NAME}"
            curl -s -X POST "https://api.render.com/v1/services/${SERVICE_ID}/deploys" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{"clearCache": "do_not_clear"}'
            
            PREVIEW_URL=$(curl -s -H "Authorization: Bearer ${RENDER_API_KEY}" \
              "https://api.render.com/v1/services/${SERVICE_ID}" | \
              jq -r '.service.serviceDetails.url')
          fi
          
          echo "preview_url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
          echo "service_id=${SERVICE_ID}" >> $GITHUB_OUTPUT

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.deploy.outputs.preview_url }}';
            const body = `## üöÄ Preview Deployment
            
            Your PR has been deployed to a preview environment!
            
            **Preview URL:** ${previewUrl}
            
            The preview will automatically update when you push new commits.
            
            ### Next Steps
            1. Visit the preview URL to review your changes
            2. Note: First load may take 30-60 seconds as the service starts
            3. OAuth and storage features require configuration in Render dashboard
            
            ---
            *This is an automated preview deployment. The environment uses SQLite and will be deleted when the PR is closed.*`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Deployment')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  cleanup-preview:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    
    steps:
      - name: Delete Render service
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          SERVICE_NAME="imageoptimizer-pr-${PR_NUMBER}"
          
          # Find service ID
          SERVICE_ID=$(curl -s -H "Authorization: Bearer ${RENDER_API_KEY}" \
            "https://api.render.com/v1/services" | \
            jq -r ".[] | select(.service.name == \"${SERVICE_NAME}\") | .service.id" || echo "")
          
          if [ -n "$SERVICE_ID" ]; then
            echo "Deleting preview service: ${SERVICE_NAME}"
            curl -X DELETE "https://api.render.com/v1/services/${SERVICE_ID}" \
              -H "Authorization: Bearer ${RENDER_API_KEY}"
            echo "Preview service deleted successfully"
          else
            echo "No preview service found for PR ${PR_NUMBER}"
          fi

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## üóëÔ∏è Preview Deleted\n\nThe preview environment has been deleted since this PR was closed.'
            });
